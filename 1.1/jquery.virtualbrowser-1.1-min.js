// encoding: utf-8
// jQuery.fn.virtualBrowser 1.1 - MIT/GPL Licensed - More info: http://github.com/maranomynet/virtualbrowser/
(function(d,p){d.injectBaseHrefToHtml=function(e,g){var b=g.split('#')[0],f=b[k](/([^?]*\/)?(.*)/,'$2'),a=b.split('?')[0][k](/(.*\/)?.*/,'$1');e=e[k](/(<[^>]+ (href|src|action)=["'])(["'#])/gi,'$1'+f+'$3')[k](/(<[^>]+ (href|src|action)=["'])\?/gi,'$1'+f.split('?')[0]+'?')[k](/(["'])([a-z]{3,12}:)/gi,'$1`<<`>>$2')[k](/(<[^>]+ (href|src|action)=["'])([^\/`])/gi,'$1'+a+'$3')[k](/\`<<`>>/g,'');return e};d.getResultBody=function(e){return d('<div/>').append(d(e||[]).not('script,title,meta,link,style').find('script,style').remove().end())};var B=document.location,v='isDefaultPrevented',C='preventDefault',s='stopPropagation',q='passThrough',l='virtualBrowser',w='VBbeforeload',x='VBdisengaged',y='VBload',z='VBloaded',k='replace',D=/^(https?:)?\/\//,E={'load':function(b){var f=typeof b!='string'?d(b):p,a=d(this),j=a.data(l),h=j.cfg,i=d.Event(w),m,n,F=h.loadmsgMode,c={elm:f};if(j.$$empty){c.isFirst=true;delete j.$$empty}if(f){b=f.attr('href');b=b===p?f.attr('action'):b}b=c.url=b===''?B.href:b;if(b){i[s]();a.trigger(i,c);if(!i[q]&&((i[q]===p&&f&&f[0].target&&f[0].target!=window.name)||(/^([a-z]{3,12}:|\/\/)/i.test(b)&&!b.toLowerCase()[k](D,'').indexOf(B.href.toLowerCase()[k](D,'').split('/')[0])==0))){i[q]=true}i[q]&&i[C]();if(!i[v]()){var I=c.noCache=c.noCache!==p?c.noCache:h.noCache,o=h.params||'',t='GET';if(f&&f.is('form')){t=f.attr('method')||t;o+='&'+f.serialize();var u=j._0;if(u){var A=u.elm;if(A.is(':image')){var G=A[0].name;o+='&'+G+'.x='+Math.round(u.X)+'&'+G+'.y='+Math.round(u.Y)}else{o+='&'+d.param(A)}delete j._0}o=o.replace(/^&+/,'')}c.params=o;c.method=t;d.ajax({url:c.url.split('#')[0],data:o,type:t,cache:!I,complete:function(e,g){c.result=d.injectBaseHrefToHtml(e.responseText,c.url);c.xhr=e;c.status=g;if(h.selector){c.resultDOM=d.getResultBody(c.result).find(h.selector)}m=d.Event(y);m[s]();a.trigger(m,c);if(!m[v]()){n=d.Event(z);n[s]();h.loadmsgElm.detach();c.resultDOM=c.resultDOM||d.getResultBody(c.result).contents();a.empty().append(c.resultDOM);j.lastRequest=c;a.trigger(n,c);delete c.resultDOM;delete c.result;delete c.xhr}if(h.disengage){a[l]('disengage')}}});if(F&&F!='none'){h.loadmsgMode=='replace'&&a.empty();a.append(h.loadmsgElm)}}}return i},'data':function(){return d(this).data(l)},'disengage':function(){var e=d(this);e.removeData(l).unbind('click submit',H).unbind(y+' '+z+' '+w).trigger(x).unbind(x)}},H=function(e){var g=d(e.target).closest(e.type=='click'?'[href], input:submit, button:submit, input:image':'form');if(g[0]){if(!e[v]()){if(!g.is('input, button')){var b=E['load'].call(this,g);if(!b[q]){e[C]();b.isPropagationStopped()&&e[s]()}}else if(!g[0].disabled){var f=d(this).data(l);_0=f._0={elm:g};if(g.is(':image')){var a=g.offset();_0.X=e.pageX-a.left;_0.Y=e.pageY-a.top}setTimeout(function(){delete f._0},0)}}}},r=d.fn[l]=function(a,j){var h=this,i=typeof a=='string';if(i){var m=E[a],n;if(m){h.each(function(e){var g=m.apply(this,[].concat(j));if(!e){n=g}})}if(n!==p){return n}}else{h.each(function(){var e=d(this),g=d.extend({},r.defaults,a);j&&(g.url=j);var b=g.loadmsgElm||'<div class="loading" />',f=(r.i18n[e.closest('*[lang]').attr('lang')]||{}).loading||r.i18n.en.loading;if(b.charAt){b=b.replace(/%\{msg\}/g,f)}b=g.loadmsgElm=d(b);if(!b.text()){b.append(f)}e.data(l,{cfg:g,$$empty:1})}).bind('click submit',H);a.onLoad&&h.bind(y,a.onLoad);a.onLoaded&&h.bind(z,a.onLoaded);a.onBeforeload&&h.bind(w,a.onBeforeload);a.onDisengaged&&h.bind(x,a.onDisengaged);a.params=typeof a.params=='string'?a.params:d.param(a.params||{});a.url&&h[l]('load',a.url)}return this};r.defaults={loadmsgMode:'none'};r.i18n={en:{loading:'Loading...'},is:{loading:'Sæki gögn...'}}})(jQuery);
