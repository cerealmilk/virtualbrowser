// encoding: utf-8
// $.fn.virtualBrowser 1.1  -- (c) 2010 Hugsmiðjan ehf. 
(function(b,n){b.injectBaseHrefToHtml=function(a,f){var c=f.split('#')[0],d=c[i](/([^?]*\/)?(.*)/,'$2'),e=c.split('?')[0][i](/(.*\/)?.*/,'$1');a=a[i](/(<[^>]+ (href|src|action)=["'])(["'#])/gi,'$1'+d+'$3')[i](/(<[^>]+ (href|src|action)=["'])\?/gi,'$1'+d.split('?')[0]+'?')[i](/(["'])([a-z]{3,12}:)/gi,'$1`<<`>>$2')[i](/(<[^>]+ (href|src|action)=["'])([^\/`])/gi,'$1'+e+'$3')[i](/\`<<`>>/g,'');return a};b.getResultBody=function(a){return b('<div/>').append(b(a||[]).not('script,title,meta,link,style').find('script,style').remove().end())};var u=document.location,q='isDefaultPrevented',o='stopPropagation',m='passThrough',l='virtualBrowser',v='VBbeforeload',w='VBload',x='VBloaded',i='replace',y=/^(https?:)?\/\//,z={'load':function(c){var d=typeof c!='string'?b(c):n,e=b(this),h=e.data(l),j=h.cfg,k=b.Event(v),p,r,A=j.loadmsgMode,g=h.lastRequest={elm:d};if(d){c=d.attr('href');c=c===n?d.attr('action'):c}c=g.url=c===''?u.href:c;if(c){k[o]();e.trigger(k,g);if(!k[m]&&((k[m]===n&&d&&d[0].target&&d[0].target!=window.name)||(/^([a-z]{3,12}:|\/\/)/i.test(c)&&!c.toLowerCase()[i](y,'').indexOf(u.href.toLowerCase()[i](y,'').split('/')[0])==0))){k[m]=true}k[m]&&k.preventDefault();if(!k[q]()){var s=j.params,B=g.noCache,C;if(d&&d.is('form')){s=d.serialize()+'&'+s;C=d.attr('method')||'GET'}b.ajax({url:g.url.split('#')[0],data:s,type:C,cache:B!==n?B:!j.noCache,complete:function(a,f){g.result=b.injectBaseHrefToHtml(a.responseText,g.url);g.xhr=a;g.status=f;p=b.Event(w);p[o]();e.trigger(p,g);if(!p[q]()){r=b.Event(x);r[o]();j.loadmsgElm.detach();e.empty().append(g.resultDOM||b.getResultBody(g.result)[0].childNodes).trigger(r,{url:g.url,elm:g.elm}).bind('click',E).find('form').data(l+'Elm',e).bind('submit',D)}}});if(A&&A!='none'){j.loadmsgMode=='replace'&&e.empty();e.append(j.loadmsgElm)}}}return k},'data':function(){return b(this).data(l)}},E=function(a){var f=b(a.target).closest('[href]');if(f[0]){a.VBbody=this;D.call(f,a)}},D=function(a){if(!a[q]()){var f=this,c=a.VBbody||b(f).data(l+'Elm')||this;bfloadEv=z['load'].call(c,f);bfloadEv.isPropagationStopped()&&a[o]();!bfloadEv[m]&&a.preventDefault()}},t=b.fn[l]=function(a,f){var c=typeof a=='string';if(c){var d=z[a];d&&this.each(function(){d.apply(this,[].concat(f))})}else{a=b.extend({loadmsgMode:'none'},a||{});f&&(a.url=f);var e=this,h=a.loadmsgElm||'<div class="loading" />',j=(t.i18n[e.closest('*[lang]').attr('lang')]||{}).loading||t.i18n.en.loading;if(h.charAt){h=h.replace(/%\{msg\}/g,j)}h=a.loadmsgElm=b(h);if(!h.text()){h.append(j)}e.data(l,{cfg:a});a.onLoad&&e.bind(w,a.onLoad);a.onLoaded&&e.bind(x,a.onLoaded);a.onBeforeload&&e.bind(v,a.onBeforeload);a.params=typeof a.params=='string'?a.params:b.param(a.params||{});a.url&&e[l]('load',a.url)}return this};t.i18n={en:{loading:'Loading...'},is:{loading:'Sæki gögn...'}}})(jQuery);
