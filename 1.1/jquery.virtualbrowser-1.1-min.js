// encoding: utf-8
// jQuery.fn.virtualBrowser 1.1 - MIT/GPL Licensed - More info: http://github.com/maranomynet/virtualbrowser/
(function(e,t){e.injectBaseHrefToHtml=function(d,j){var f=j.split('#')[0],a=f[l](/([^?]*\/)?(.*)/,'$2'),b=f.split('?')[0][l](/(.*\/)?.*/,'$1');d=d[l](/(<[^>]+ (href|src|action)=["'])(["'#])/gi,'$1'+a+'$3')[l](/(<[^>]+ (href|src|action)=["'])\?/gi,'$1'+a.split('?')[0]+'?')[l](/(["'])([a-z]{3,12}:)/gi,'$1`<<`>>$2')[l](/(<[^>]+ (href|src|action)=["'])([^\/`])/gi,'$1'+b+'$3')[l](/\`<<`>>/g,'');return d};e.getResultBody=function(d){return e('<div/>').append(e(d||[]).not('script,title,meta,link,style').find('script,style').remove().end())};var E=document.location,A='isDefaultPrevented',F='preventDefault',w='stopPropagation',u='passThrough',m='virtualBrowser',G='VBbeforeload',H='VBload',I='VBerror',J='VBloaded',K='VBdisengaged',l='replace',o='resultDOM',p='result',L=/^(https?:)?\/\//,M={'load':function(a){var b=typeof a!='string'?e(a):t,g=e(this),k=g.data(m),h=k.cfg,i=e.Event(G),q,r,s=h.loadmsgMode,c={elm:b};if(k.$$empty){c.isFirst=true;delete k.$$empty}if(b){a=b.attr('href');a=a===t?b.attr('action'):a}a=c.url=a===''?E.href:a;if(a){i[w]();g.trigger(i,[c]);if(!i[u]&&((i[u]===t&&b&&b[0].target&&b[0].target!=window.name)||(/^([a-z]{3,12}:|\/\/)/i.test(a)&&!a.toLowerCase()[l](L,'').indexOf(E.href.toLowerCase()[l](L,'').split('/')[0])==0))){i[u]=true}i[u]&&i[F]();if(!i[A]()){var R=c.noCache=c.noCache!==t?c.noCache:h.noCache,n=h.params||'',x='GET';if(b&&b.is('form')){x=b.attr('method')||x;n+='&'+b.serialize();var y=k._0;if(y){var B=y.elm;if(B.is(':image')){var N=B[0].name;n+='&'+N+'.x='+Math.round(y.X)+'&'+N+'.y='+Math.round(y.Y)}else{n+='&'+e.param(B)}delete k._0}n=n.replace(/^&+|&+$/g,'');var O='multipart/form-data';i._1=!!b.find('input:file')[0]||b.attr('enctype')==O||b.attr('encoding')==O}c.params=n;c.method=x;if(s&&s!='none'){h.loadmsgMode=='replace'&&g.empty();g.append(h.loadmsgElm)}var z={url:c.url.split('#')[0],data:n,type:x,cache:!R,complete:function(d,j){c.xhr=d;c.status=j||'error';var f=!j||j=='error';if(f){g.trigger(I,[c])}else{c[p]=e.injectBaseHrefToHtml(d.responseText||'',c.url)}if(c[p]&&h.selector){c[o]=e.getResultBody(c[p]).find(h.selector)}if(!f||c[p]||c[o]){q=e.Event(H);q[w]();g.trigger(q,[c]);if(!q[A]()){r=e.Event(J);r[w]();h.loadmsgElm.detach();c[o]=c[o]||e.getResultBody(c[p]).contents();g.empty().append(c[o]);k.lastRequest=c;g.trigger(r,[c]);delete c[o];delete c[p]}}delete c.xhr;if(h.disengage){g[m]('disengage')}}};if(!i._1){e.ajax(z)}else{z=e.extend({},z);var P='if'+(new Date).getTime(),C=e('<iframe name="'+P+'" src="about:blank" style="position:absolute;top:-999em;left:-999em;visibility:hidden;" />').appendTo('body'),S=function(){var d='success';z.complete({fakeXHR:'iframe',responseText:'<html>'+C.contents().find('html').html()+'</html>'},d);b.attr({target:T,action:D});setTimeout(function(){C.remove()},0)},D=b.attr('action')||'',T=b.attr('target')||'';b.attr('target',P);if(h.params){b.attr('action',D+(/\?/.test(D)?'&':'?')+h.params)}C.bind('load',S)}}}return i},'data':function(){return e(this).data(m)},'disengage':function(){var d=e(this);d.removeData(m).unbind('click submit',Q).unbind([G,I,H,J].join(' ')).trigger(K).unbind(K)}},Q=function(d){var j=d.type=='submit',f=e(d.target).closest(j?'form':'[href], input:submit, button:submit, input:image');if(f[0]){if(!d[A]()){if(f.is('input, button')){if(!f[0].disabled){var a=e(this).data(m);if(f.is(':image')){var b=f.offset();a._0={elm:f,X:d.pageX-b.left,Y:d.pageY-b.top}}else if(f.is('[name]')){a._0={elm:f}}setTimeout(function(){delete a._0},0)}}else{var g=M['load'].call(this,f);if(!g[u]){!g._1&&d[F]();g.isPropagationStopped()&&d[w]()}}}}},v=e.fn[m]=function(k,h){var i=this,q=typeof k=='string';if(q){var r=M[k],s;if(r){i.each(function(d){var j=r.apply(this,[].concat(h));if(!d){s=j}})}if(s!==t){return s}}else{i.each(function(){var f=e(this),a=e.extend({},v.defaults,k);e.each(['Beforeload','Error','Load','Loaded','Disengage'],function(d,j){d='on'+j;a[d]&&i.bind('VB'+j.toLowerCase(),a[d]);delete a[d]});a.params=typeof a.params=='string'?a.params:e.param(a.params||{});h&&(a.url=h);var b=a.loadmsgElm||'<div class="loading" />',g=(v.i18n[f.closest('*[lang]').attr('lang')]||{}).loading||v.i18n.en.loading;if(b.charAt){b=b.replace(/%\{msg\}/g,g)}b=a.loadmsgElm=e(b);if(!b.text()){b.append(g)}f.data(m,{cfg:a,$$empty:1});a.url&&f[m]('load',a.url)}).bind('click submit',Q)}return this};v.defaults={loadmsgMode:'none'};v.i18n={en:{loading:'Loading...'},is:{loading:'Sæki gögn...'}}})(jQuery);
