// encoding: utf-8
// $.fn.virtualBrowser 1.0  -- (c) 2009 Hugsmiðjan ehf. 
(function(c,m){c.fn.detach=c.fn.detach||function(){return this.each(function(){var a=this.parentNode;a&&a.nodeType==1&&a.removeChild(this)})};c.injectBaseHrefToHtml=function(a,h){var b=h.split('#')[0],e=b[g](/([^?]*\/)?(.*)/,'$2'),f=b.split('?')[0][g](/(.*\/)?.*/,'$1'),d=/\?/.test(b);d&&(a=a[g](/(['"])\?/gi,'$1¨<<`>>'));a=a[g](/(<[^>]+ (href|src|action)=["'])(["'#¨])/gi,'$1'+e+'$3');d&&(a=a[g](/(['"])¨<<`>>/gi,'$1?')[g](/¨<<`>>/gi,'&amp;'));a=a[g](/http:\/\//gi,'^<<`>>')[g](/https:\/\//gi,'`<<`>>')[g](/(<[^>]+ (href|src|action)=["'])([^\/`\^])/gi,'$1'+f+'$3')[g](/\^<<`>>/g,'http://')[g](/\^<<`>>/g,'http://')[g](/`<<`>>/g,'https://');return a};var t=document.location,p='isDefaultPrevented',n='stopPropagation',l='passThrough',k='virtualBrowser',u='VBbeforeload',v='VBload',w='VBloaded',g='replace',x=/^(https?:)?\/\//,y={'load':function(b){var e=typeof b!='string'?c(b):m,f=c(this),d=f.data(k).cfg,j=c.Event(u),o,q,z=d.loadmsgMode,i={elm:e};if(e){b=e.attr('href');b=b===m?e.attr('action'):b}b=i.url=b===''?t.href:b;if(b){j[n]();f.trigger(j,i);if(!j[l]&&((j[l]===m&&e&&e[0].target&&e[0].target!=window.name)||(/^([a-z]{3,12}:|\/\/)/i.test(b)&&!b.toLowerCase()[g](x,'').indexOf(t.href.toLowerCase()[g](x,'').split('/')[0])==0))){j[l]=true}j[l]&&j.preventDefault();if(!j[p]()){var r=d.params,A=i.noCache,B;if(e&&e.is('form')){r=e.serialize()+'&'+r;B=e.attr('method')||'GET'}c.ajax({url:i.url.split('#')[0],data:r,type:B,cache:A!==m?A:!d.noCache,complete:function(a,h){i.result=c.injectBaseHrefToHtml(a.responseText,i.url);i.xhr=a;i.status=h;o=c.Event(v);o[n]();f.trigger(o,i);if(!o[p]()){q=c.Event(w);q[n]();d.loadmsgElm.detach();f.empty().append(i.resultDOM||c.getResultBody(i.result)[0].childNodes).trigger(q,{url:i.url,elm:i.elm}).bind('click',D).find('form').data(k+'Elm',f).bind('submit',C)}}});if(z&&z!='none'){d.loadmsgMode=='replace'&&f.empty();f.append(d.loadmsgElm)}}}return j}},D=function(a){var h=c(a.target).closest('[href]');if(h[0]){a.VBbody=this;C.call(h,a)}},C=function(a){if(!a[p]()){var h=this,b=a.VBbody||c(h).data(k+'Elm')||this;bfloadEv=y['load'].call(b,h);bfloadEv.isPropagationStopped()&&a[n]();!bfloadEv[l]&&a.preventDefault()}},s=c.fn[k]=function(a,h){var b=typeof a=='string';if(b){var e=y[a];e&&this.each(function(){e.apply(this,[].concat(h))})}else{a=c.extend({loadmsgMode:'none'},a||{});h&&(a.url=h);var f=this,d=a.loadmsgElm||'<div class="loading" />',j=(s.i18n[f.closest('*[lang]').attr('lang')]||{}).loading||s.i18n.en.loading;if(d.charAt){d=d.replace(/%\{msg\}/g,j)}d=a.loadmsgElm=c(d);if(!d.text()){d.append(j)}f.data(k,{cfg:a});a.onLoad&&f.bind(v,a.onLoad);a.onLoaded&&f.bind(w,a.onLoaded);a.onBeforeload&&f.bind(u,a.onBeforeload);a.params=typeof a.params=='string'?a.params:c.param(a.params||{});a.url&&f[k]('load',a.url)}return this};s.i18n={en:{loading:'Loading...'},is:{loading:'Sæki gögn...'}}})(jQuery);
